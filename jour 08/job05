<?php
session_start();

// Réinitialiser la partie
if (isset($_POST['reset'])) {
    session_destroy();
    header("Location: " . $_SERVER['PHP_SELF']);
    exit;
}

// Initialisation de la grille et du tour
if (!isset($_SESSION['grid'])) {
    $_SESSION['grid'] = array_fill(0, 9, '-'); // 9 cases avec "-"
    $_SESSION['tour'] = 'X'; // X commence
    $_SESSION['game_over'] = false;
}

// Si une case est cliquée et que la partie n'est pas terminée
if (isset($_POST['case']) && !$_SESSION['game_over']) {
    $index = (int)$_POST['case'];

    // Si la case est vide, on joue
    if ($_SESSION['grid'][$index] === '-') {
        $_SESSION['grid'][$index] = $_SESSION['tour'];

        // Vérifie s’il y a un gagnant
        $gagnant = checkWinner($_SESSION['grid']);
        if ($gagnant) {
            $message = "$gagnant a gagné !";
            $_SESSION['game_over'] = true;
        }
        // Vérifie le match nul
        elseif (!in_array('-', $_SESSION['grid'])) {
            $message = "Match nul !";
            $_SESSION['game_over'] = true;
        } else {
            // Changer de joueur
            $_SESSION['tour'] = ($_SESSION['tour'] === 'X') ? 'O' : 'X';
        }
    }
}

// Fonction pour vérifier le gagnant
function checkWinner($grid) {
    $wins = [
        [0,1,2], [3,4,5], [6,7,8], // lignes
        [0,3,6], [1,4,7], [2,5,8], // colonnes
        [0,4,8], [2,4,6]           // diagonales
    ];

    foreach ($wins as $combo) {
        if ($grid[$combo[0]] !== '-' &&
            $grid[$combo[0]] === $grid[$combo[1]] &&
            $grid[$combo[1]] === $grid[$combo[2]]) {
            return $grid[$combo[0]]; // retourne 'X' ou 'O'
        }
    }
    return false;
}
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Jeu du Morpion</title>
    <style>
        table {
            border-collapse: collapse;
            margin: 20px auto;
        }
        td {
            width: 60px;
            height: 60px;
            text-align: center;
        }
        button {
            width: 100%;
            height: 100%;
            font-size: 24px;
        }
        .message {
            text-align: center;
            font-size: 24px;
            margin-top: 10px;
            color: darkblue;
        }
        .reset {
            display: block;
            margin: 10px auto;
        }
    </style>
</head>
<body>

<form method="post">
    <table border="1">
        <?php for ($i = 0; $i < 3; $i++): ?>
            <tr>
                <?php for ($j = 0; $j < 3; $j++): 
                    $index = $i * 3 + $j;
                    ?>
                    <td>
                        <?php if ($_SESSION['grid'][$index] === '-' && !$_SESSION['game_over']): ?>
                            <button type="submit" name="case" value="<?= $index ?>">-</button>
                        <?php else: ?>
                            <span style="font-size:24px"><?= $_SESSION['grid'][$index] ?></span>
                        <?php endif; ?>
                    </td>
                <?php endfor; ?>
            </tr>
        <?php endfor; ?>
    </table>

    <button type="submit" name="reset" class="reset">Réinitialiser la partie</button>
</form>

<?php if (isset($message)): ?>
    <div class="message"><?= $message ?></div>
<?php endif; ?>

</body>
</html>
